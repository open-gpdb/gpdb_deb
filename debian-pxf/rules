#!/usr/bin/make -f
# You must remove unused comment lines for the released package.
DH_VERBOSE = 1
DPKG_EXPORT_BUILDFLAGS = 1

# assumes that CWD is root of gpdb source
PXF_SRC_DIR := $(shell pwd)
DEBIAN_DESTINATION := ${PXF_SRC_DIR}/debian/build
GP_PATH_SCRIPT := $(shell find . -name "greenplum_path.sh"|tail -1)
export JAVA_HOME := /usr/lib/jvm/default-java
export GOPATH := ${PXF_SRC_DIR}/go
export GPHOME := ${DEBIAN_DESTINATION}/greenplum-db-6-6.11.1/bin_gpdb
export PATH := $(GOPATH)/bin:$(PATH):$(GPHOME)/bin
DEP := $(shell go get github.com/golang/dep/cmd/dep)
GINKGO := $(shell go get github.com/onsi/ginkgo/ginkgo)
#GETGP := $(shell wget http://ppa.launchpad.net/greenplum/db/ubuntu/pool/main/g/greenplum-db-6/greenplum-db-6_6.11.1.orig.tar.gz &&)

$(info    GOPATH is $(GOPATH))
$(info    PATH is $(PATH))
$(info    GPVAR is $(GP_PATH_SCRIPT))

include /usr/share/dpkg/default.mk

%:
	dh $@

override_dh_auto_configure:
	echo "Skipping autoconfigure"

getgp:
	mkdir -p ${DEBIAN_DESTINATION}
	wget -c http://ppa.launchpad.net/greenplum/db/ubuntu/pool/main/g/greenplum-db-6/greenplum-db-6_6.11.1.orig.tar.gz && \
          tar -xzf greenplum-db-6_6.11.1.orig.tar.gz -C ${DEBIAN_DESTINATION} && \
          rm -rf greenplum-db-6_6.11.1.orig.tar.gz && \
          export GPHOME=${DEBIAN_DESTINATION}/greenplum-db-6-6.11.1/bin_gpdb && \
          export PATH=${PATH}:${GPHOME}/bin

override_dh_auto_build: getgp
	make clean
	sed -i "s#gradlew#gradlew -g ${PXF_SRC_DIR}/server/gradle-user-home#g" ${PXF_SRC_DIR}/server/Makefile
	make

override_dh_auto_install:
	ln -s -f ${GPHOME} ${DEBIAN_DESTINATION}/gp
	PXF_HOME=${DEBIAN_DESTINATION} make install

override_dh_auto_clean:
	echo "Skipping clean"

override_dh_auto_test:
	echo "Skipping auto test"

override_dh_strip_nondeterminism:
	echo "Skipping dh_strip_nondeterminism"
