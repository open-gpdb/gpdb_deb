#!/usr/bin/make -f
# You must remove unused comment lines for the released package.
DH_VERBOSE = 1
DPKG_EXPORT_BUILDFLAGS = 1

# assumes that CWD is root of gpdb source
PXF_SRC_DIR := $(shell pwd)
DEBIAN_DESTINATION := ${PXF_SRC_DIR}/debian/build
GP_PATH_SCRIPT := $(shell find . -name "greenplum_path.sh"|tail -1)
GP_VERSION := 6.11.1
GO_VERSION := 1.12
 
export JAVA_HOME := /usr/lib/jvm/java-1.11.0-openjdk-amd64
export GPHOME := ${DEBIAN_DESTINATION}/greenplum-db-6-${GP_VERSION}/bin_gpdb

export GOROOT := ${PXF_SRC_DIR}/go
export GOPATH := ${PXF_SRC_DIR}/cli/go
export PATH := $(GOPATH)/bin:$(GOROOT)/bin:$(GPHOME)/bin:$(PATH):

$(info    GOPATH is $(GOPATH))
$(info    PATH is $(PATH))
$(info    GPVAR is $(GP_PATH_SCRIPT))
$(info    GOROOT is $(GOROOT))

include /usr/share/dpkg/default.mk

%:
	dh $@

override_dh_auto_configure:
	echo "Skipping autoconfigure"

getgp:
	mkdir -p ${DEBIAN_DESTINATION} && \
        wget -c http://ppa.launchpad.net/greenplum/db/ubuntu/pool/main/g/greenplum-db-6/greenplum-db-6_${GP_VERSION}.orig.tar.gz -O - | tar -xz -C ${DEBIAN_DESTINATION}/ 

getgo:
	wget -c https://dl.google.com/go/go${GO_VERSION}.linux-amd64.tar.gz -O - | tar -xz
	./go/bin/go get github.com/golang/dep/cmd/dep
	./go/bin/go get github.com/onsi/ginkgo/ginkgo

override_dh_auto_build: getgp getgo
	make clean
	sed -i "s#gradlew#gradlew -g ${PXF_SRC_DIR}/server/gradle-user-home#g" ${PXF_SRC_DIR}/server/Makefile
	make

override_dh_auto_install:
	ln -s -f ${GPHOME} ${DEBIAN_DESTINATION}/gp
	PXF_HOME=${DEBIAN_DESTINATION} make install
	./server/gradlew --stop

override_dh_auto_test:
	echo "Skipping auto test"

override_dh_auto_clean:
	echo "Skipping auto clean"

override_dh_strip_nondeterminism:
	echo "Skipping dh_strip_nondeterminism"
